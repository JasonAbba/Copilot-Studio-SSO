<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Enterprise Chat - V0.1</title>
    <script src="https://alcdn.msauth.net/browser/2.35.0/js/msal-browser.min.js"></script>
    <script src="https://cdn.botframework.com/botframework-webchat/latest/webchat.js"></script>
    <style>
        html, body { height: 100%; margin: 0; font-family: 'Segoe UI', sans-serif; }
        #header { 
            height: 60px; background: #0078d4; color: white; 
            display: flex; align-items: center; justify-content: space-between; 
            padding: 0 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); 
        }
        #webchat { height: calc(100% - 60px); width: 100%; background: #f4f4f4; }
        .btn-logout { 
            background: #d83b01; color: white; border: none; padding: 8px 15px; 
            cursor: pointer; border-radius: 4px; font-weight: 600;
        }
        .btn-logout:hover { background: #a82a00; }
    </style>
</head>
<body>

    <div id="header">
        <span id="user-info">Authenticating...</span>
        <button id="btn-signout" class="btn-logout" style="display:none;" onclick="signOut()">Sign Out</button>
    </div>
    <div id="webchat" role="main"></div>

    <script>
    // --- CONFIGURATION (Pre-filled from your uploaded file) ---
    const config = {
        msal: {
            auth: {
                clientId: "be17ba3a-270e-4169-a3d6-a0787579b080", // Canvas App ID
                authority: "https://login.microsoftonline.com/24917450-fe15-4414-92ed-94fa8ec1b938", // Tenant ID
                redirectUri: "https://jasonabba.github.io/Copilot-Studio-SSO/",
                postLogoutRedirectUri: "https://jasonabba.github.io/Copilot-Studio-SSO/"
            },
            cache: { cacheLocation: "sessionStorage" }
        },
        bot: {
            scope: "api://8f264357-07e8-4604-8bcf-aba89e3efb6c/access_as_user", // Auth App ID
            tokenEndpoint: "https://15f7ece55636e98d9c5cc2f68ef371.97.environment.api.powerplatform.com/powervirtualagents/botsbyschema/cr6c4_sysforeAgent/directline/token?api-version=2022-03-01-preview"
        }
    };

    const msalInstance = new msal.PublicClientApplication(config.msal);

    async function init() {
        console.log("üöÄ Initializing MSAL and WebChat...");
        
        try {
            // 1. Handle Redirect (if returning from Azure Login)
            await msalInstance.handleRedirectPromise();
            
            // 2. Check for Active Session
            const accounts = msalInstance.getAllAccounts();
            if (accounts.length === 0) {
                console.warn("‚ö†Ô∏è No active session found. Redirecting to Login...");
                msalInstance.loginRedirect({ scopes: ["User.Read", config.bot.scope] });
                return;
            }

            const user = accounts[0];
            document.getElementById('user-info').innerText = `Logged in: ${user.name}`;
            document.getElementById('btn-signout').style.display = 'block';

            // 3. Fetch Direct Line Token
            const dlRes = await fetch(config.bot.tokenEndpoint);
            const { token } = await dlRes.json();
            
            // Create DirectLine Object
            const directLine = window.WebChat.createDirectLine({ token });

            // 4. SSO Store Middleware (The Core Logic)
            const store = window.WebChat.createStore({}, ({ dispatch }) => next => async action => {
                
                // --- A. PROACTIVE GREETING ---
                if (action.type === 'DIRECT_LINE/CONNECT_FULFILLED') {
                    console.log("üì° Connected. Sending 'startConversation' event...");
                    dispatch({
                        type: 'DIRECT_LINE/POST_ACTIVITY',
                        meta: {
                            method: 'keyboard' // <--- FIXES THE CRASH ERROR
                        },
                        payload: {
                            activity: {
                                type: 'event',
                                name: 'startConversation',
                                value: {}
                            }
                        }
                    });
                }

                // --- B. SILENT SSO HANDLING ---
                if (action.type === 'DIRECT_LINE/INCOMING_ACTIVITY') {
                    const activity = action.payload.activity;

                    // Detect the OAuth Card (The "Sign-in" Prompt)
                    if (activity.attachments?.[0]?.contentType === 'application/vnd.microsoft.card.oauth') {
                        console.group("üîê SSO Card Detected");
                        const content = activity.attachments[0].content;
                        
                        // We look for 'tokenExchangeResource' (Standard for Copilot Studio)
                        const tokenExchangeResource = content.tokenExchangeResource;
                        
                        if (tokenExchangeResource) {
                            console.log("Found Token Exchange Resource. Attempting Silent Invoke...");
                            try {
                                // 1. Get Token Silently from MSAL
                                const tokenResult = await msalInstance.acquireTokenSilent({
                                    scopes: [config.bot.scope],
                                    account: user
                                });

                                // 2. Send the Token to the Bot using 'invoke'
                                directLine.postActivity({
                                    type: 'invoke',
                                    name: 'signin/tokenExchange',
                                    value: {
                                        id: tokenExchangeResource.id,
                                        connectionName: content.connectionName,
                                        token: tokenResult.accessToken
                                    },
                                    from: {
                                        id: user.localAccountId,
                                        name: user.name,
                                        role: "user"
                                    }
                                }).subscribe(
                                    id => console.log("‚úÖ SSO Invoke Sent. ID:", id),
                                    err => console.error("‚ùå SSO Invoke Failed:", err)
                                );

                                console.groupEnd();
                                return; // <--- CRITICAL: Stops the card from being shown to the user
                            } catch (err) {
                                console.error("Token Acquisition Failed", err);
                            }
                        } else {
                            console.warn("‚ö†Ô∏è No tokenExchangeResource found. Cannot perform SSO.");
                        }
                        console.groupEnd();
                    }
                }
                return next(action);
            });

            // 5. Render WebChat
            window.WebChat.renderWebChat({
                directLine: directLine,
                store: store,
                userID: user.localAccountId,
                styleOptions: {
                    hideUploadButton: true
                }
            }, document.getElementById('webchat'));
            
        } catch (err) {
            console.error("Critical Error:", err);
        }
    }

    function signOut() {
        const logoutRequest = {
            account: msalInstance.getAccountByHomeId(msalInstance.getAllAccounts()[0].homeAccountId),
            postLogoutRedirectUri: config.msal.auth.postLogoutRedirectUri,
        };
        msalInstance.logoutRedirect(logoutRequest);
    }

    init();
    </script>
</body>
</html>
