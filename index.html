<! DOCTYPE html>

<html lang="en">

<head>

    <meta charset="UTF-8">

    <title>Enterprise Chat - V0.2</title>

    <script src="https://alcdn.msauth.net/browser/2.35.0/js/msal-browser.min.js"></script>

    <script src="https://cdn.botframework.com/botframework-webchat/latest/webchat.js"></script>

    <style>

        html, body { height: 100%; margin: 0; font-family: 'Segoe UI', sans-serif; }

        #header { 

            height: 60px; background:  #0078d4; color: white; 

            display: flex; align-items: center; justify-content:  space-between; 

            padding: 0 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); 

        }

        #webchat { height: calc(100% - 60px); width: 100%; background: #f4f4f4; }

        . btn-logout { 

            background: #d83b01; color: white; border: none; padding: 8px 15px; 

            cursor: pointer; border-radius: 4px; font-weight: 600;

        }

        .btn-logout:hover { background: #a82a00; }

    </style>

</head>

<body>

    <div id="header">

        <span id="user-info">Authenticating...</span>

        <button id="btn-signout" class="btn-logout" style="display: none;" onclick="signOut()">Sign Out</button>

    </div>

    <div id="webchat" role="main"></div>

    <script>

    const config = {

        msal: {

            auth: {

                clientId: "be17ba3a-270e-4169-a3d6-a0787579b080",

                authority: "https://login.microsoftonline.com/24917450-fe15-4414-92ed-94fa8ec1b938",

                redirectUri: "https://jasonabba.github.io/Copilot-Studio-SSO/",

                postLogoutRedirectUri: "https://jasonabba.github.io/Copilot-Studio-SSO/"

            },

            cache: { cacheLocation: "sessionStorage" }

        },

        bot: {

            scope: "api://8f264357-07e8-4604-8bcf-aba89e3efb6c/access_as_user",

            tokenEndpoint: "https://15f7ece55636e98d9c5cc2f68ef371.97.environment.api.powerplatform.com/powervirtualagents/botsbyschema/cr6c4_sysforeAgent/directline/token?api-version=2022-03-01-preview"

        }

    };

    const msalInstance = new msal.PublicClientApplication(config.msal);

    let globalUser = null;

    async function init() {

        console.log("üöÄ Initializing MSAL and WebChat...");

        try {

            // 1. Handle Redirect

            const redirectResult = await msalInstance.handleRedirectPromise();

            if (redirectResult) {

                console.log("‚úÖ Returned from redirect.  User logged in.");

            }

            // 2. Check Accounts

            const accounts = msalInstance.getAllAccounts();

            if (accounts.length === 0) {

                console.warn("‚ö†Ô∏è No active session found. Redirecting to Login.. .");

                msalInstance.loginRedirect({ scopes: ["User.Read", config.bot.scope] });

                return;

            }

            const user = accounts[0];

            globalUser = user;

            console. group("üë§ User Authenticated");

            console.log("Name:", user.name);

            console.log("Username:", user.username);

            console.log("Local ID:", user.localAccountId);

            console.groupEnd();

            document.getElementById('user-info').innerText = `Logged in:  ${user.name}`;

            document.getElementById('btn-signout').style.display = 'block';

            // 3. Fetch Direct Line Token

            console.log("ü§ñ Fetching Bot Token from endpoint...");

            let dlRes;

            try {

                dlRes = await fetch(config.bot. tokenEndpoint);

                if (!dlRes.ok) {

                    throw new Error(`Token endpoint returned ${dlRes.status}: ${await dlRes.text()}`);

                }

            } catch (err) {

                console.error("‚ùå Failed to fetch from token endpoint:", err);

                alert("Error: Could not connect to bot. Please check the token endpoint URL.");

                return;

            }

            const tokenData = await dlRes.json();

            if (!tokenData.token) {

                console.error("‚ùå No token in response:", tokenData);

                alert("Error: Bot token endpoint returned no token.");

                return;

            }

            const { token } = tokenData;

            console.log("‚úÖ Bot Token acquired.");

            // 4. Create SSO Interceptor Store

            const store = window.WebChat.createStore({}, ({ dispatch }) => next => async action => {

                // Intercept incoming activities to handle OAuth cards
                if (action.type === 'DIRECT_LINE/INCOMING_ACTIVITY') {

                    const activity = action.payload. activity;

                    // Check if this is an OAuth Card (Sign In Card)
                    if (activity. attachments && 

                        activity.attachments.length > 0 && 

                        activity.attachments[0].contentType === 'application/vnd.microsoft.card.oauth') {

                        console.group("üîê SSO OAuth Card Intercepted");

                        try {

                            const content = activity.attachments[0]. content;

                            const sasUrl = content?. tokenPostResource?.sasUrl;

                            const connectionName = content?.connectionName;

                            console.log("Connection Name:", connectionName);

                            console.log("OAuth Card Details:", {

                                sasUrl: sasUrl ?  "Present" : "Missing",

                                connectionName: connectionName,

                                tokenPostResource: content?.tokenPostResource

                            });

                            if (! sasUrl) {

                                console.error("‚ùå ERROR: sasUrl is missing from the OAuth card.");

                                console.info("‚ö†Ô∏è Fix: Check Copilot Studio auth settings:");

                                console.info("   1. Verify App ID matches clientId in MSAL config");

                                console.info("   2. Ensure scope matches:  " + config.bot.scope);

                                console.info("   3. Check that Manual auth is enabled");

                                console. groupEnd();

                                return next(action); // Show card for debugging

                            }

                            // Acquire token silently from MSAL
                            console.log("üîÑ Acquiring token silently from MSAL...");

                            let tokenResult;

                            try {

                                tokenResult = await msalInstance.acquireTokenSilent({

                                    scopes: [config. bot.scope],

                                    account: globalUser

                                });

                                console.log("‚úÖ MSAL Token Acquired Successfully");

                            } catch (silentErr) {

                                console.warn("‚ö†Ô∏è Silent token acquisition failed, attempting interactive.. .", silentErr. errorCode);

                                try {

                                    tokenResult = await msalInstance.acquireTokenPopup({

                                        scopes: [config.bot.scope],

                                        account: globalUser

                                    });

                                    console.log("‚úÖ Interactive Token Acquired");

                                } catch (interactiveErr) {

                                    console.error("‚ùå Both silent and interactive token acquisition failed:", interactiveErr);

                                    console.groupEnd();

                                    return next(action);

                                }

                            }

                            // Exchange token with bot's SAS URL
                            console.log("üì§ Exchanging token with bot SAS endpoint...");

                            try {

                                const postRes = await fetch(sasUrl, {

                                    method: 'POST',

                                    headers: { 'Content-Type':  'application/json' },

                                    body: JSON.stringify({ token: tokenResult.accessToken })

                                });

                                if (postRes.ok) {

                                    console.log("‚úÖ Token exchanged successfully (Status: " + postRes.status + ")");

                                } else {

                                    const errorText = await postRes.text();

                                    console.error("‚ùå Token POST failed (Status: " + postRes.status + ")", errorText);

                                }

                            } catch (postErr) {

                                console. error("‚ùå Token POST request failed:", postErr. message);

                            }

                            console.groupEnd();

                            // Don't render the OAuth card if successful
                            return; 

                        } catch (err) {

                            console.error("‚ùå Unexpected error in OAuth interceptor:", err);

                            console.groupEnd();

                            return next(action);

                        }

                    }

                }

                return next(action);

            });

            // 5. Render WebChat with store

            console.log("üé® Rendering WebChat.. .");

            window.WebChat. renderWebChat({

                directLine: window.WebChat.createDirectLine({ token }),

                store:  store,

                userID: user.localAccountId,

                username: user.name

            }, document.getElementById('webchat'));

            console.log("‚úÖ WebChat initialized successfully");

        } catch (err) {

            console.group("‚ùå Critical Error in init()");

            console.error("Error Details:", err);

            if (err.stack) console.error("Stack:", err.stack);

            console.groupEnd();

            document.getElementById('user-info').innerText = "‚ùå Error initializing chat.  Check console. ";

        }

    }

    function signOut() {

        console. log("üëã Signing out...");

        try {

            const accounts = msalInstance.getAllAccounts();

            if (accounts.length > 0) {

                const logoutRequest = {

                    account: msalInstance.getAccountByHomeId(accounts[0].homeAccountId),

                    postLogoutRedirectUri: config.msal.auth. postLogoutRedirectUri,

                };

                msalInstance. logoutRedirect(logoutRequest);

            }

        } catch (err) {

            console. error("‚ùå Sign out error:", err);

        }

    }

    // Initialize on page load
    init();

    </script>

</body>

</html>
