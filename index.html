<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Enterprise Chat - Robust</title>
    <script src="https://cdn.botframework.com/botframework-webchat/4.18.0/webchat.js"></script>
    <script src="https://alcdn.msauth.net/browser/2.35.0/js/msal-browser.min.js"></script>
    <style>
        html, body { height: 100%; margin: 0; font-family: 'Segoe UI', sans-serif; background-color: #f0f2f5; }
        
        #chat-container {
            height: 100%;
            display: flex;
            flex-direction: column;
            max-width: 100%;
            margin: 0 auto;
            background: white;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        #header { 
            height: 64px; 
            background: linear-gradient(90deg, #0078d4 0%, #005a9e 100%); 
            color: white; 
            display: flex; 
            align-items: center; 
            justify-content: space-between; 
            padding: 0 24px; 
            font-weight: 600;
            font-size: 18px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            z-index: 10;
        }

        #webchat { 
            flex: 1; 
            overflow: hidden; 
            position: relative; 
        }

        .btn-logout { 
            background: rgba(255, 255, 255, 0.2); 
            color: white; 
            border: 1px solid rgba(255, 255, 255, 0.4); 
            padding: 8px 16px; 
            cursor: pointer; 
            border-radius: 20px; 
            font-weight: 500;
            font-size: 14px;
            transition: all 0.2s ease;
        }
        .btn-logout:hover { background: rgba(255, 255, 255, 0.3); }

        #loader {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100%;
            color: #666;
        }
    </style>
</head>
<body>

    <div id="chat-container">
        <div id="header">
            <span id="user-info">Authenticating...</span>
            <button id="btn-signout" class="btn-logout" style="display:none;" onclick="signOut()">Sign Out</button>
        </div>
        <div id="webchat" role="main">
            <div id="loader">Loading Copilot...</div>
        </div>
    </div>

    <script>
    const config = {
        msal: {
            auth: {
                clientId: "be17ba3a-270e-4169-a3d6-a0787579b080", 
                authority: "https://login.microsoftonline.com/24917450-fe15-4414-92ed-94fa8ec1b938",
                redirectUri: "https://jasonabba.github.io/Copilot-Studio-SSO/", 
                postLogoutRedirectUri: "https://jasonabba.github.io/Copilot-Studio-SSO/" 
            },
            cache: { cacheLocation: "sessionStorage" }
        },
        bot: {
            scope: "api://8f264357-07e8-4604-8bcf-aba89e3efb6c/access_as_user", 
            tokenEndpoint: "https://15f7ece55636e98d9c5cc2f68ef371.97.environment.api.powerplatform.com/powervirtualagents/botsbyschema/cr6c4_sysforeAgent/directline/token?api-version=2022-03-01-preview"
        }
    };

    const msalInstance = new msal.PublicClientApplication(config.msal);

    async function init() {
        console.log("üöÄ Initializing...");
        
        try {
            await msalInstance.handleRedirectPromise();
            const accounts = msalInstance.getAllAccounts();

            if (accounts.length === 0) {
                msalInstance.loginRedirect({ scopes: ["User.Read", config.bot.scope] });
                return;
            }

            const user = accounts[0];
            document.getElementById('user-info').innerText = `Hello, ${user.name}`;
            document.getElementById('btn-signout').style.display = 'block';

            const userInitials = user.name ? user.name.split(' ').slice(0, 2).map(n => n[0]).join('').toUpperCase() : 'ME'; 

            const dlRes = await fetch(config.bot.tokenEndpoint);
            const { token } = await dlRes.json();
            
            const loader = document.getElementById('loader');
            if(loader) loader.remove();

            const directLine = window.WebChat.createDirectLine({ token });

            // --- STYLE OPTIONS ---
            const styleOptions = {
                backgroundColor: '#F3F2F1', 
                bubbleBackground: '#FFFFFF', 
                bubbleFromUserBackground: '#0078D4', 
                bubbleTextColor: '#000000',
                bubbleFromUserTextColor: '#FFFFFF',
                bubbleBorderRadius: 18,
                bubbleFromUserBorderRadius: 18,
                botAvatarInitials: 'CS', 
                userAvatarInitials: userInitials, 
                botAvatarBackgroundColor: '#0078D4',
                userAvatarBackgroundColor: '#201F1E',
                bubbleFromUserNuance: 'top', 
                bubbleNuance: 'top',
                paddingRegular: 10,
                hideUploadButton: true,
                sendBoxBackground: '#FFFFFF',
                sendBoxButtonColor: '#0078D4',
                sendBoxBorderTop: '1px solid #E5E5E5',
                sendBoxHeight: 50
            };

            // --- REDUX STORE MIDDLEWARE ---
            const store = window.WebChat.createStore({}, ({ dispatch }) => next => action => {
                
                // 1. Proactive Greeting
                if (action.type === 'DIRECT_LINE/CONNECT_FULFILLED') {
                    dispatch({
                        type: 'DIRECT_LINE/POST_ACTIVITY',
                        meta: { method: 'keyboard' },
                        payload: { activity: { type: 'event', name: 'startConversation', value: {} } }
                    });
                }

                // 2. SSO Token Logic
                if (action.type === 'DIRECT_LINE/INCOMING_ACTIVITY') {
                    const activity = action.payload.activity;
                    if (activity.attachments?.[0]?.contentType === 'application/vnd.microsoft.card.oauth') {
                        const content = activity.attachments[0].content;
                        if (content.tokenExchangeResource) {
                            (async () => {
                                try {
                                    const tokenResult = await msalInstance.acquireTokenSilent({
                                        scopes: [config.bot.scope],
                                        account: user
                                    });
                                    directLine.postActivity({
                                        type: 'invoke',
                                        name: 'signin/tokenExchange',
                                        value: {
                                            id: content.tokenExchangeResource.id,
                                            connectionName: content.connectionName,
                                            token: tokenResult.accessToken
                                        },
                                        from: { id: user.localAccountId, name: user.name, role: "user" }
                                    }).subscribe();
                                } catch (e) { console.error("SSO Error:", e); }
                            })();
                        }
                    }
                }
                return next(action);
            });

            // --- RENDER WEB CHAT ---
            window.WebChat.renderWebChat({
                directLine: directLine,
                store: store,
                userID: user.localAccountId,
                styleOptions: styleOptions,

                // --- CRASH-PROOF ACTIVITY MIDDLEWARE ---
                activityMiddleware: () => next => card => children => {
                    // 1. Fetch the default renderer for this card
                    const Renderer = next(card);

                    // 2. SECURITY CHECK: If WebChat didn't return a function (it returned undefined or a component directly), 
                    // simply return it. Calling it as Renderer(children) would crash.
                    if (typeof Renderer !== 'function') {
                        return Renderer;
                    }

                    // 3. Render the standard chat bubble
                    const originalBubble = Renderer(children);

                    // 4. Access React Safely
                    const React = window.WebChat.React;

                    // 5. If React is missing (CDN issue) OR this isn't a user message, just return the bubble.
                    if (!React || card.activity.type !== 'message') {
                        return originalBubble;
                    }

                    // 6. If safe, wrap in the Accordion
                    return React.createElement(
                        'div',
                        { style: { display: 'flex', flexDirection: 'column', marginBottom: '10px' } },
                        
                        originalBubble,

                        React.createElement(
                            'details',
                            { style: { marginTop: '4px', marginLeft: '10px', fontSize: '11px', fontFamily: 'Consolas, monospace', color: '#666', maxWidth: '85%' } },
                            React.createElement(
                                'summary', 
                                { style: { cursor: 'pointer', outline: 'none', userSelect: 'none' } }, 
                                'üîç View JSON'
                            ),
                            React.createElement(
                                'pre',
                                { style: { backgroundColor: '#f8f9fa', padding: '10px', border: '1px solid #dee2e6', borderRadius: '4px', overflowX: 'auto', marginTop: '5px' } },
                                JSON.stringify(card.activity, null, 2)
                            )
                        )
                    );
                }
                // --- END MIDDLEWARE ---

            }, document.getElementById('webchat'));
            
        } catch (err) {
            console.error("Error:", err);
        }
    }

    function signOut() {
        const logoutRequest = {
            account: msalInstance.getAccountByHomeId(msalInstance.getAllAccounts()[0].homeAccountId),
            postLogoutRedirectUri: config.msal.auth.postLogoutRedirectUri,
        };
        msalInstance.logoutRedirect(logoutRequest);
    }

    init();
    </script>
</body>
</html>
