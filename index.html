<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Enterprise Chat - GitHub Pages</title>
    <script src="https://alcdn.msauth.net/browser/2.35.0/js/msal-browser.min.js"></script>
    <script src="https://cdn.botframework.com/botframework-webchat/latest/webchat.js"></script>
    <style>
        html, body { height: 100%; margin: 0; font-family: 'Segoe UI', sans-serif; }
        #header { 
            height: 60px; background: #0078d4; color: white; 
            display: flex; align-items: center; justify-content: space-between; 
            padding: 0 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); 
        }
        #webchat { height: calc(100% - 60px); width: 100%; background: #f4f4f4; }
        .btn-logout { 
            background: #d83b01; color: white; border: none; padding: 8px 15px; 
            cursor: pointer; border-radius: 4px; font-weight: 600;
        }
        .btn-logout:hover { background: #a82a00; }
    </style>
</head>
<body>

    <div id="header">
        <span id="user-info">Authenticating...</span>
        <button id="btn-signout" class="btn-logout" style="display:none;" onclick="signOut()">Sign Out</button>
    </div>
    <div id="webchat" role="main"></div>

    <script>
    const config = {
        msal: {
            auth: {
                clientId: "be17ba3a-270e-4169-a3d6-a0787579b080",
                authority: "https://login.microsoftonline.com/24917450-fe15-4414-92ed-94fa8ec1b938",
                redirectUri: "https://jasonabba.github.io/Copilot-Studio-SSO/",
                postLogoutRedirectUri: "https://jasonabba.github.io/Copilot-Studio-SSO/"
            },
            cache: { cacheLocation: "sessionStorage" }
        },
        bot: {
            scope: "api://8f264357-07e8-4604-8bcf-aba89e3efb6c/access_as_user",
            tokenEndpoint: "https://15f7ece55636e98d9c5cc2f68ef371.97.environment.api.powerplatform.com/powervirtualagents/botsbyschema/cr6c4_sysforeAgent/directline/token?api-version=2022-03-01-preview"
        }
    };

    const msalInstance = new msal.PublicClientApplication(config.msal);

    async function init() {
        console.log("üöÄ Initializing MSAL and WebChat...");
        
        try {
            // 1. Handle Redirect
            const redirectResult = await msalInstance.handleRedirectPromise();
            if (redirectResult) {
                console.log("‚úÖ Returned from redirect. User logged in.");
            }

            // 2. Check Accounts
            const accounts = msalInstance.getAllAccounts();
            if (accounts.length === 0) {
                console.warn("‚ö†Ô∏è No active session found. Redirecting to Login...");
                msalInstance.loginRedirect({ scopes: ["User.Read", config.bot.scope] });
                return;
            }

            const user = accounts[0];
            console.group("üë§ User Authenticated");
            console.log("Name:", user.name);
            console.log("Username:", user.username);
            console.log("Local ID:", user.localAccountId);
            console.groupEnd();

            document.getElementById('user-info').innerText = `Logged in: ${user.name}`;
            document.getElementById('btn-signout').style.display = 'block';

            // 3. Fetch Direct Line Token
            console.log("ü§ñ Fetching Bot Token from endpoint...");
            const dlRes = await fetch(config.bot.tokenEndpoint);
            const { token } = await dlRes.json();
            console.log("‚úÖ Bot Token acquired.");

            // 4. SSO Interceptor & Proactive Trigger Store
            const store = window.WebChat.createStore({}, ({ dispatch }) => next => async action => {
    
            // 1. SAFETY GUARD: Check if action and payload exist before processing
            if (!action) return next(action);
        
            // 2. PROACTIVE GREETING
            if (action.type === 'DIRECT_LINE/CONNECT_FULFILLED') {
                console.log("üì° Connected. Sending greeting...");
                dispatch({
                    type: 'DIRECT_LINE/POST_ACTIVITY',
                    payload: {
                        activity: {
                            type: 'event',
                            name: 'startConversation',
                            value: {}
                        }
                    }
                });
            }
        
            // 3. SSO INTERCEPTOR
            if (action.type === 'DIRECT_LINE/INCOMING_ACTIVITY' && action.payload && action.payload.activity) {
                const activity = action.payload.activity;
        
                if (activity.attachments?.[0]?.contentType === 'application/vnd.microsoft.card.oauth') {
                    const content = activity.attachments[0].content;
                    
                    // Use Optional Chaining (?.) to prevent "Cannot read properties of undefined"
                    const sasUrl = content?.tokenPostResource?.sasUrl;
        
                    if (sasUrl) {
                        try {
                            const accounts = msalInstance.getAllAccounts();
                            if (accounts.length > 0) {
                                const tokenResult = await msalInstance.acquireTokenSilent({
                                    scopes: [config.bot.scope],
                                    account: accounts[0]
                                });
        
                                await fetch(sasUrl, {
                                    method: 'POST', // This is likely where your error was originating
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({ token: tokenResult.accessToken })
                                });
                                console.log("‚úÖ SSO Token Posted.");
                                return; // Successfully handled, don't show card
                            }
                        } catch (err) {
                            console.error("SSO Token Exchange Error:", err);
                        }
                    }
                }
            }
        
            return next(action);
        });

            // 5. Render WebChat
            window.WebChat.renderWebChat({
                directLine: window.WebChat.createDirectLine({ token }),
                store: store,
                userID: user.localAccountId
            }, document.getElementById('webchat'));
            
            console.log("üé® WebChat rendered.");

        } catch (err) {
            console.group("‚ùå Critical Error in init()");
            console.error(err);
            console.groupEnd();
        }
    }

    function signOut() {
        console.log("üëã Signing out...");
        const logoutRequest = {
            account: msalInstance.getAccountByHomeId(msalInstance.getAllAccounts()[0].homeAccountId),
            postLogoutRedirectUri: config.msal.auth.postLogoutRedirectUri,
        };
        msalInstance.logoutRedirect(logoutRequest);
    }

    init();
</script>
    
</body>
</html>
