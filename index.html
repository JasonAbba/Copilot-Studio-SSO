<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Enterprise Chat - Modern UI</title>
<script src="https://alcdn.msauth.net/browser/2.35.0/js/msal-browser.min.js"></script>
<script src="https://cdn.botframework.com/botframework-webchat/latest/webchat.js"></script>
<style>
        html, body { height: 100%; margin: 0; font-family: 'Segoe UI', sans-serif; background-color: #f0f2f5; }
        /* Main Container for the Chat Widget */
        #chat-container {
            height: 100%;
            display: flex;
            flex-direction: column;
            max-width: 100%;
            margin: 0 auto;
            background: white;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
 
        /* Modern Header */
        #header { 
            height: 64px; 
            background: linear-gradient(90deg, #0078d4 0%, #005a9e 100%); 
            color: white; 
            display: flex; 
            align-items: center; 
            justify-content: space-between; 
            padding: 0 24px; 
            font-weight: 600;
            font-size: 18px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            z-index: 10;
        }
 
        #webchat { 
            flex: 1; 
            overflow: hidden; 
            position: relative; 
        }
 
        /* Logout Button Styling */
        .btn-logout { 
            background: rgba(255, 255, 255, 0.2); 
            color: white; 
            border: 1px solid rgba(255, 255, 255, 0.4); 
            padding: 8px 16px; 
            cursor: pointer; 
            border-radius: 20px; 
            font-weight: 500;
            font-size: 14px;
            transition: all 0.2s ease;
        }
        .btn-logout:hover { 
            background: rgba(255, 255, 255, 0.3); 
        }
 
        /* Loading Overlay */
        #loader {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100%;
            color: #666;
        }
</style>
</head>
<body>
 
    <div id="chat-container">
<div id="header">
<span id="user-info">Authenticating...</span>
<button id="btn-signout" class="btn-logout" style="display:none;" onclick="signOut()">Sign Out</button>
</div>
<div id="webchat" role="main">
<div id="loader">Loading Copilot...</div>
</div>
</div>
 
    <script>
    // --- CONFIGURATION ---
    const config = {
        msal: {
            auth: {
                clientId: "be17ba3a-270e-4169-a3d6-a0787579b080", //Copilot-Canvas-App Client ID
                authority: "https://login.microsoftonline.com/24917450-fe15-4414-92ed-94fa8ec1b938",
                redirectUri: "https://jasonabba.github.io/Copilot-Studio-SSO/", // This is where the user will be redirected to after successful login
                postLogoutRedirectUri: "https://jasonabba.github.io/Copilot-Studio-SSO/" // This is where the user will be redirected to after successful logout
            },
            cache: { cacheLocation: "sessionStorage" }
        },
        bot: {
            scope: "api://8f264357-07e8-4604-8bcf-aba89e3efb6c/access_as_user", //Scope from Copilot-Auth-App 
            tokenEndpoint: "https://15f7ece55636e98d9c5cc2f68ef371.97.environment.api.powerplatform.com/powervirtualagents/botsbyschema/cr6c4_sysforeAgent/directline/token?api-version=2022-03-01-preview"
        }
    };
 
    const msalInstance = new msal.PublicClientApplication(config.msal);
 
    async function init() {
        console.log("ðŸš€ Initializing...");
        try {
            await msalInstance.handleRedirectPromise();
            const accounts = msalInstance.getAllAccounts();
 
            // Check if there is a valid login available in browser
            if (accounts.length === 0) {
                msalInstance.loginRedirect({ scopes: ["User.Read", config.bot.scope] });
                return;
            }
 
            const user = accounts[0];
            document.getElementById('user-info').innerText = `Hello, ${user.name}`;
            document.getElementById('btn-signout').style.display = 'block';
 
            //Generate Initials - "Abba Jason Samuel" -> ["Abba", "Jason", "Samuel"] -> ["A", "J"] -> "AJ"
            const userInitials = user.name ? user.name.split(' ').slice(0, 2).map(n => n[0]).join('').toUpperCase() : 'ME'; // Fallback if name is missing
 
            // Fetch Token
            const dlRes = await fetch(config.bot.tokenEndpoint);
            const { token } = await dlRes.json();
            // Remove Loader
            const loader = document.getElementById('loader');
            if(loader) loader.remove();
 
            const directLine = window.WebChat.createDirectLine({ token });
 
            // --- AESTHETIC STYLE OPTIONS ---
            const styleOptions = {
                // Backgrounds
                backgroundColor: '#F3F2F1', // Light grey chat background
                bubbleBackground: '#FFFFFF', // White bot bubbles
                bubbleFromUserBackground: '#0078D4', // User blue bubbles
                // Text Colors
                bubbleTextColor: '#000000',
                bubbleFromUserTextColor: '#FFFFFF',
 
                // Border Radius (Rounded corners)
                bubbleBorderRadius: 18,
                bubbleFromUserBorderRadius: 18,
                // Avatars
                botAvatarInitials: 'CS', // Copilot Studio
                userAvatarInitials: userInitials, 
                botAvatarBackgroundColor: '#0078D4',
                userAvatarBackgroundColor: '#201F1E',
                // Spacing & sizing
                bubbleFromUserNuance: 'top', // Stacks user messages nicely
                bubbleNuance: 'top',
                paddingRegular: 10,
 
                // Send Box Styling
                hideUploadButton: true,
                sendBoxBackground: '#FFFFFF',
                sendBoxButtonColor: '#0078D4',
                sendBoxBorderTop: '1px solid #E5E5E5',
                sendBoxHeight: 50
            };
 
            const store = window.WebChat.createStore({}, ({ dispatch }) => next => async action => {
                // 1. Proactive Greeting
                if (action.type === 'DIRECT_LINE/CONNECT_FULFILLED') {
                    dispatch({
                        type: 'DIRECT_LINE/POST_ACTIVITY',
                        meta: { method: 'keyboard' },
                        payload: {
                            activity: { type: 'event', name: 'startConversation', value: {} }
                        }
                    });
                }
 
                // 2. SSO Logic
                if (action.type === 'DIRECT_LINE/INCOMING_ACTIVITY') {
                    const activity = action.payload.activity;
                    if (activity.attachments?.[0]?.contentType === 'application/vnd.microsoft.card.oauth') {
                        const content = activity.attachments[0].content;
                        if (content.tokenExchangeResource) {
                            try {
                                const tokenResult = await msalInstance.acquireTokenSilent({
                                    scopes: [config.bot.scope],
                                    account: user
                                });
                                directLine.postActivity({
                                    type: 'invoke',
                                    name: 'signin/tokenExchange',
                                    value: {
                                        id: content.tokenExchangeResource.id,
                                        connectionName: content.connectionName,
                                        token: tokenResult.accessToken
                                    },
                                    from: { id: user.localAccountId, name: user.name, role: "user" }
                                }).subscribe();
                                return; // Hide card
                            } catch (e) { console.error(e); }
                        }
                    }
                }
 
                // console all the activities to/from Copilot Agent
                if (action.payload?.activity) {
                    console.log("ðŸš¨ Activity Logged:");
                    console.log(JSON.stringify(action.payload.activity, null, 2));
                }
                return next(action);
            });
 
            window.WebChat.renderWebChat({
                directLine: directLine,
                store: store,
                userID: user.localAccountId,
                styleOptions: styleOptions
            }, document.getElementById('webchat'));
        } catch (err) {
            console.error("Error:", err);
        }
    }
 
    function signOut() {
        const logoutRequest = {
            account: msalInstance.getAccountByHomeId(msalInstance.getAllAccounts()[0].homeAccountId),
            postLogoutRedirectUri: config.msal.auth.postLogoutRedirectUri,
        };
        msalInstance.logoutRedirect(logoutRequest);
    }
 
    init();
</script>
</body>
</html>
